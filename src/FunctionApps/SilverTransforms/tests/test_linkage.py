from unittest import mock

import pandas as pd
from RecordLinkage.linkage import *

@mock.patch("RecordLinkage.linkage.merge_duplicates")
def test_linkage():

    incoming = {
        'patients': [
            {"resourceType":"Patient","id":"cb26aa5c-b5e9-4b8b-963e-902ffecf0154","meta":{"versionId":"1","lastUpdated":"2022-01-31T21:43:30.008+00:00"},"active":true,"name":[{"use":"official","family":"Kirk","given":["James","Tiberious"]},{"use":"usual","given":["Jim"]}],"gender":"male","birthDate":"1960-12-25"},
            {"resourceType":"Patient","id":"cb26aa5c-b5e9-4b8b-963e-902ffecf0154","meta":{"versionId":"1","lastUpdated":"2022-01-31T21:43:30.008+00:00"},"active":true,"name":[{"use":"official","family":"Kirk","given":["James","Tiberious"]},{"use":"usual","given":["Jim"]}],"gender":"male","birthDate":"1960-1-25"},
            {"resourceType":"Patient","id":"52271ada-ad3d-02e5-6bf8-7d01b38a9c84","meta":{"versionId":"2","lastUpdated":"2022-02-02T22:54:01.944+00:00"},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by <a href=\"https://github.com/synthetichealth/synthea\">Synthea</a>.Version identifier: master-branch-latest\n .   Person seed: -6061321512527560083  Population seed: 1643834518691</div>"},"extension":[{"url":"http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName","valueString":"Micah422 Reichert620"},{"url":"http://hl7.org/fhir/StructureDefinition/patient-birthPlace","valueAddress":{"city":"Boston","state":"Massachusetts","country":"US"}},{"url":"http://synthetichealth.github.io/synthea/disability-adjusted-life-years","valueDecimal":0.0},{"url":"http://synthetichealth.github.io/synthea/quality-adjusted-life-years","valueDecimal":102.0}],"identifier":[{"system":"https://github.com/synthetichealth/synthea","value":"52271ada-ad3d-02e5-6bf8-7d01b38a9c84"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"MR","display":"Medical Record Number"}],"text":"Medical Record Number"},"system":"http://hospital.smarthealthit.org","value":"52271ada-ad3d-02e5-6bf8-7d01b38a9c84"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"SS","display":"Social Security Number"}],"text":"Social Security Number"},"system":"http://hl7.org/fhir/sid/us-ssn","value":"999-66-4944"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"DL","display":"Driver's License"}],"text":"Driver's License"},"system":"urn:oid:2.16.840.1.113883.4.3.25","value":"S99970616"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"PPN","display":"Passport Number"}],"text":"Passport Number"},"system":"http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber","value":"X50552415X"}],"name":[{"use":"official","family":"Pollich983","given":["Deneen201"],"prefix":["Mrs."]},{"use":"maiden","family":"Conn188","given":["Deneen201"],"prefix":["Mrs."]}],"telecom":[{"system":"phone","value":"555-905-8926","use":"home"}],"gender":"female","birthDate":"1919-11-10","address":[{"extension":[{"extension":[{"url":"latitude","valueDecimal":42.1408839404588},{"url":"longitude","valueDecimal":-71.22137721510623}],"url":"http://hl7.org/fhir/StructureDefinition/geolocation"}],"line":["734 Bernhard Manor"],"city":"Sharon","state":"Massachusetts","postalCode":"02067","country":"US"}],"maritalStatus":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v3-MaritalStatus","code":"M","display":"M"}],"text":"M"},"multipleBirthBoolean":false,"communication":[{"language":{"coding":[{"system":"urn:ietf:bcp:47","code":"en-US","display":"English"}],"text":"English"}}]},
            {"resourceType":"Patient","id":"94ca1022-8ef5-798c-eb1e-1706ad4f5807","meta":{"versionId":"1","lastUpdated":"2022-02-02T22:55:21.023+00:00"},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by <a href=\"https://github.com/synthetichealth/synthea\">Synthea</a>.Version identifier: master-branch-latest\n .   Person seed: 5969961965304914359  Population seed: 1643842297440</div>"},"extension":[{"url":"http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName","valueString":"Daniella68 Breitenberg711"},{"url":"http://hl7.org/fhir/StructureDefinition/patient-birthPlace","valueAddress":{"city":"Marion","state":"Massachusetts","country":"US"}},{"url":"http://synthetichealth.github.io/synthea/disability-adjusted-life-years","valueDecimal":0.0},{"url":"http://synthetichealth.github.io/synthea/quality-adjusted-life-years","valueDecimal":21.0}],"identifier":[{"system":"https://github.com/synthetichealth/synthea","value":"94ca1022-8ef5-798c-eb1e-1706ad4f5807"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"MR","display":"Medical Record Number"}],"text":"Medical Record Number"},"system":"http://hospital.smarthealthit.org","value":"94ca1022-8ef5-798c-eb1e-1706ad4f5807"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"SS","display":"Social Security Number"}],"text":"Social Security Number"},"system":"http://hl7.org/fhir/sid/us-ssn","value":"999-55-2895"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"DL","display":"Driver's License"}],"text":"Driver's License"},"system":"urn:oid:2.16.840.1.113883.4.3.25","value":"S99969631"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"PPN","display":"Passport Number"}],"text":"Passport Number"},"system":"http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber","value":"X53601621X"}],"name":[{"use":"official","family":"Denesik803","given":["Aldo414"],"prefix":["Mr."]}],"telecom":[{"system":"phone","value":"555-667-7048","use":"home"}],"gender":"male","birthDate":"2000-01-22","address":[{"extension":[{"extension":[{"url":"latitude","valueDecimal":41.67988181138803},{"url":"longitude","valueDecimal":-71.15989157955373}],"url":"http://hl7.org/fhir/StructureDefinition/geolocation"}],"line":["749 Lindgren Center"],"city":"Fall River","state":"Massachusetts","postalCode":"02747","country":"US"}],"maritalStatus":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v3-MaritalStatus","code":"S","display":"Never Married"}],"text":"Never Married"},"multipleBirthBoolean":false,"communication":[{"language":{"coding":[{"system":"urn:ietf:bcp:47","code":"en-US","display":"English"}],"text":"English"}}]},
            {"resourceType":"Patient","id":"94ca1022-8ef5-798c-eb1e-1706ad4f5807","meta":{"versionId":"1","lastUpdated":"2022-02-02T22:55:21.023+00:00"},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by <a href=\"https://github.com/synthetichealth/synthea\">Synthea</a>.Version identifier: master-branch-latest\n .   Person seed: 5969961965304914359  Population seed: 1643842297440</div>"},"extension":[{"url":"http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName","valueString":"Daniella68 Breitenberg711"},{"url":"http://hl7.org/fhir/StructureDefinition/patient-birthPlace","valueAddress":{"city":"Marion","state":"Massachusetts","country":"US"}},{"url":"http://synthetichealth.github.io/synthea/disability-adjusted-life-years","valueDecimal":0.0},{"url":"http://synthetichealth.github.io/synthea/quality-adjusted-life-years","valueDecimal":21.0}],"identifier":[{"system":"https://github.com/synthetichealth/synthea","value":"94ca1022-8ef5-798c-eb1e-1706ad4f5807"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"MR","display":"Medical Record Number"}],"text":"Medical Record Number"},"system":"http://hospital.smarthealthit.org","value":"94ca1022-8ef5-798c-eb1e-1706ad4f5807"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"SS","display":"Social Security Number"}],"text":"Social Security Number"},"system":"http://hl7.org/fhir/sid/us-ssn","value":"999-55-2895"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"DL","display":"Driver's License"}],"text":"Driver's License"},"system":"urn:oid:2.16.840.1.113883.4.3.25","value":"S99969631"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"PPN","display":"Passport Number"}],"text":"Passport Number"},"system":"http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber","value":"X53601621X"}],"name":[{"use":"official","family":"Denesik803","given":["Aldo414"],"prefix":["Mr."]}],"telecom":[{"system":"phone","value":"555-667-7048","use":"home"}],"gender":"male","birthDate":"2000-01-22","maritalStatus":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v3-MaritalStatus","code":"S","display":"Never Married"}],"text":"Never Married"},"multipleBirthBoolean":false,"communication":[{"language":{"coding":[{"system":"urn:ietf:bcp:47","code":"en-US","display":"English"}],"text":"English"}}]},
            {"resourceType":"Patient","id":"94ca1022-8ef5-798c-eb1e-1706ad4f5807","meta":{"versionId":"1","lastUpdated":"2022-02-02T22:55:21.023+00:00"},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by <a href=\"https://github.com/synthetichealth/synthea\">Synthea</a>.Version identifier: master-branch-latest\n .   Person seed: 5969961965304914359  Population seed: 1643842297440</div>"},"extension":[{"url":"http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName","valueString":"Daniella68 Breitenberg711"},{"url":"http://hl7.org/fhir/StructureDefinition/patient-birthPlace","valueAddress":{"city":"Marion","state":"Massachusetts","country":"US"}},{"url":"http://synthetichealth.github.io/synthea/disability-adjusted-life-years","valueDecimal":0.0},{"url":"http://synthetichealth.github.io/synthea/quality-adjusted-life-years","valueDecimal":21.0}],"identifier":[{"system":"https://github.com/synthetichealth/synthea","value":"94ca1022-8ef5-798c-eb1e-1706ad4f5807"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"MR","display":"Medical Record Number"}],"text":"Medical Record Number"},"system":"http://hospital.smarthealthit.org","value":"94ca1022-8ef5-798c-eb1e-1706ad4f5807"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"SS","display":"Social Security Number"}],"text":"Social Security Number"},"system":"http://hl7.org/fhir/sid/us-ssn","value":"999-55-2895"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"DL","display":"Driver's License"}],"text":"Driver's License"},"system":"urn:oid:2.16.840.1.113883.4.3.25","value":"S99969631"},{"type":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v2-0203","code":"PPN","display":"Passport Number"}],"text":"Passport Number"},"system":"http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber","value":"X53601621X"}],"name":[{"use":"official","family":"Denesik803","given":["Aldo414"],"prefix":["Mr."]}],"telecom":[{"system":"phone","value":"555-667-7048","use":"home"}],"birthDate":"2000-01-22","address":[{"extension":[{"extension":[{"url":"latitude","valueDecimal":41.67988181138803},{"url":"longitude","valueDecimal":-71.15989157955373}],"url":"http://hl7.org/fhir/StructureDefinition/geolocation"}],"line":["749 Lindgren Center"],"city":"Fall River","state":"Massachusetts","postalCode":"02747","country":"US"}],"maritalStatus":{"coding":[{"system":"http://terminology.hl7.org/CodeSystem/v3-MaritalStatus","code":"S","display":"Never Married"}],"text":"Never Married"},"multipleBirthBoolean":false,"communication":[{"language":{"coding":[{"system":"urn:ietf:bcp:47","code":"en-US","display":"English"}],"text":"English"}}]}
        ],
        'nonpatients': ["placeholder"]
    }

    patient_resources = pd.DataFrame.from_records(incoming['patients'])

    patients = create_linking_identifier(patient_resources)
    patients = merge_duplicates(patients, 'linking_identifier', record_combination_func)

    assert len(patients) == 4